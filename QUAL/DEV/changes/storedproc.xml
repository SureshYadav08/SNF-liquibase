<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
  <changeSet author="SureshYadav" id="1">
    < SQL > CREATE OR REPLACE PROCEDURE Load_Staging_Zone 
(PARAMS VARIANT)RETURNS STRING LANGUAGE JAVASCRIPT EXECUTE 
AS
CALLER 
AS
$$ var successLog = '';
var errorLog = '';
var TableName = PARAMS["SOURCE_TABLE_NAME"];
var schemaName = PARAMS["SCHEMA_NAME"];
var databaseName = PARAMS["DATABASE_NAME"];
var path = PARAMS["path"];
FUNCTION logError (errorMessage) { errorLog + = errorMessage + '\n';
} FUNCTION logSuccess (successMessage) { successLog + = successMessage + '\n';
} try { var currentTimestamp = new DATE ();
var formattedTimestamp = currentTimestamp.toLocaleString ('en-GB',{ timeZone:'UTC',day:'2-digit',MONTH:'2-digit',YEAR:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}). REPLACE(/[\ / \s,:] / g,'-');
var create_stage_sql = ` COPY INTO ${path}_${formattedTimestamp}.json.gz FROM (SELECT OBJECT_CONSTRUCT(*) FROM "${databaseName}"."${schemaName}"."${TableName}") FILE_FORMAT = (TYPE = 'JSON') SINGLE = TRUE OVERWRITE = TRUE; `;
snowflake.execute ({ sqlText:create_stage_sql });
logSuccess ('Step 1: created successfully.');
} catch (err) { logError ('Step 1 Error: ' + err);
} IF (errorLog != = '') { RETURN 'Error: ' + errorLog;
} logSuccess ('Final result: SUCCESS');
RETURN successLog;
$$;
</ SQL >
	
    <rollback>
      <sql>

      </sql>
    </rollback>
  </changeSet>
</databaseChangeLog>
